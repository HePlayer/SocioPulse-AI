# å¤šAgentè®¨è®ºæ¡†æ¶

## æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¤šAgentè®¨è®ºæ¡†æ¶ï¼Œå®ç°äº†è¿ç»­å¾ªç¯æ¶æ„å’Œå¹¶è¡ŒSVRï¼ˆStop-Value-Repeatï¼‰è®¡ç®—ã€‚æ¡†æ¶æä¾›å®æ—¶ç›‘æ§ã€äº‹ä»¶é©±åŠ¨çš„æ¶æ„ï¼Œå¹¶ä¸ç°æœ‰çš„SocioPulse AIç³»ç»Ÿå®Œå…¨é›†æˆã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ”„ è¿ç»­å¾ªç¯æ¶æ„
- å®ç°ä¼ªä»£ç ä¸­çš„è¿ç»­è®¨è®ºå¾ªç¯
- å¹¶è¡ŒSVRè®¡ç®—ä¸é˜»å¡è®¨è®ºæµç¨‹
- å®æ—¶å†³ç­–åˆ¶å®šå’ŒAgenté€‰æ‹©

### âš¡ å¹¶è¡ŒSVRè®¡ç®—
- åŒæ—¶ä¸ºæ‰€æœ‰Agentè®¡ç®—SVRå€¼
- å¼‚æ­¥å¤„ç†ç¡®ä¿é«˜æ€§èƒ½
- è‡ªé€‚åº”é˜ˆå€¼å’Œæ™ºèƒ½å†³ç­–

### ğŸ¯ æ™ºèƒ½å†³ç­–ç³»ç»Ÿ
- åŸºäºSVRç»“æœçš„è‡ªåŠ¨å†³ç­–
- æ”¯æŒåœæ­¢ã€ç»§ç»­ã€æš‚åœã€é‡å®šå‘æ“ä½œ
- è´¨é‡ç›‘æ§å’Œå¹²é¢„æœºåˆ¶

### ğŸ”— å®Œæ•´ç³»ç»Ÿé›†æˆ
- ä¸ç°æœ‰ChatRoomã€Agent.think()æ— ç¼é›†æˆ
- ä¿æŒå‘åå…¼å®¹æ€§
- æ”¯æŒEnhancedMessageHistoryå’ŒCommunicationStrategy

### ğŸ“¡ å®æ—¶ç›‘æ§
- WebSocketå®æ—¶äº‹ä»¶æ¨é€
- å‰ç«¯å…¼å®¹çš„æ•°æ®æ ¼å¼
- æ€§èƒ½æŒ‡æ ‡å’Œç»Ÿè®¡ä¿¡æ¯

## æ¶æ„ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å¤šAgentè®¨è®ºæ¡†æ¶                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ContinuousControllerâ”‚  â”‚ParallelSVREngineâ”‚  â”‚ SVRHandler   â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ - è¿ç»­å¾ªç¯      â”‚  â”‚ - å¹¶è¡Œè®¡ç®—      â”‚  â”‚ - å†³ç­–åˆ¶å®š   â”‚ â”‚
â”‚  â”‚ - ä¸Šä¸‹æ–‡ç®¡ç†    â”‚  â”‚ - å®æ—¶ç›‘æ§      â”‚  â”‚ - Agenté€‰æ‹©  â”‚ â”‚
â”‚  â”‚ - æµç¨‹æ§åˆ¶      â”‚  â”‚ - å¼‚æ­¥å¤„ç†      â”‚  â”‚ - åœæ­¢é€»è¾‘   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                     â”‚                   â”‚       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚DiscussionContextâ”‚  â”‚ AgentSVRComputerâ”‚  â”‚EventInterfaceâ”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ - çŠ¶æ€è·Ÿè¸ª      â”‚  â”‚ - ä¸ªä½“SVR       â”‚  â”‚ - å‰ç«¯å…¼å®¹   â”‚ â”‚
â”‚  â”‚ - å†å²ç®¡ç†      â”‚  â”‚ - Agentåˆ†æ     â”‚  â”‚ - å®æ—¶äº‹ä»¶   â”‚ â”‚
â”‚  â”‚ - å®æ—¶æ•°æ®      â”‚  â”‚ - å¹¶è¡Œå®‰å…¨      â”‚  â”‚ - WebSocket  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## APIç«¯ç‚¹

### å¯åŠ¨å¢å¼ºè®¨è®º
```http
POST /api/discussion/start
Content-Type: application/json

{
  "room_id": "room_123",
  "user_input": "è¯·è®¨è®ºäººå·¥æ™ºèƒ½çš„å‘å±•è¶‹åŠ¿"
}
```

### è·å–è®¨è®ºçŠ¶æ€
```http
GET /api/discussion/status/{room_id}
```

### æ§åˆ¶è®¨è®º
```http
POST /api/discussion/control/{room_id}
Content-Type: application/json

{
  "action": "pause|resume|stop"
}
```

### è·å–æ‰€æœ‰è®¨è®ºçŠ¶æ€
```http
GET /api/discussion/all-status
```

### WebSocketå®æ—¶æ›´æ–°
```
ws://localhost:8080/ws/discussion/{room_id}
```

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```python
from Server.discussion_framework import DiscussionFrameworkManager
from Item.Communication.message_types import ChatMessage, MessageType

# åˆ›å»ºæ¡†æ¶ç®¡ç†å™¨
manager = DiscussionFrameworkManager()

# å‡†å¤‡å‚ä¸è€…ï¼ˆAgentå­—å…¸ï¼‰
participants = {
    'agent_1': ai_expert_agent,
    'agent_2': tech_analyst_agent,
    'agent_3': product_manager_agent
}

# åˆ›å»ºåˆå§‹æ¶ˆæ¯
initial_message = ChatMessage(
    sender_id="user",
    content="è¯·è®¨è®ºäººå·¥æ™ºèƒ½åœ¨æœªæ¥5å¹´çš„å‘å±•è¶‹åŠ¿",
    message_type=MessageType.TEXT
)

# å¯åŠ¨å¢å¼ºè®¨è®º
result = await manager.start_enhanced_discussion(
    room_id="ai_discussion_room",
    topic="AIå‘å±•è¶‹åŠ¿è®¨è®º",
    participants=participants,
    initial_message=initial_message
)

if result['success']:
    print(f"è®¨è®ºå¯åŠ¨æˆåŠŸ: {result['session_id']}")
    
    # ç›‘æ§è®¨è®ºçŠ¶æ€
    while True:
        status = await manager.get_discussion_status("ai_discussion_room")
        if not status.get('discussion', {}).get('active'):
            break
        await asyncio.sleep(5)
    
    print("è®¨è®ºå·²ç»“æŸ")
```

### äº‹ä»¶ç›‘å¬

```python
from Server.discussion_framework import ContinuousDiscussionController

controller = ContinuousDiscussionController()

# è®¾ç½®äº‹ä»¶å¤„ç†å™¨
async def on_turn_complete(turn):
    print(f"è½®æ¬¡å®Œæˆ: {turn.agent_name} è¯´: {turn.message.content[:50]}...")

async def on_decision_made(decision):
    print(f"å†³ç­–: {decision.action.value} - é€‰æ‹© {decision.selected_agent_name}")

controller.on_turn_complete = on_turn_complete
controller.on_decision_made = on_decision_made
```

### å‰ç«¯é›†æˆ

```javascript
// WebSocketè¿æ¥
const ws = new WebSocket('ws://localhost:8080/ws/discussion/room_123');

ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    
    switch(data.type) {
        case 'initial_status':
            updateDiscussionStatus(data.data);
            break;
        case 'event':
            handleDiscussionEvent(data);
            break;
        case 'status_update':
            updateDiscussionStatus(data.data);
            break;
    }
};

function updateDiscussionStatus(status) {
    document.getElementById('discussion-quality').textContent = 
        status.metrics.discussion_quality.toFixed(1);
    document.getElementById('consensus-level').textContent = 
        status.metrics.consensus_level.toFixed(1);
}
```

## SVRç®—æ³•è¯¦è§£

### Stop Value (åœæ­¢å€¼)
- **å…±è¯†è´¡çŒ®**: Agentå¯¹è¾¾æˆå…±è¯†çš„è´¡çŒ®åº¦
- **è®¨è®ºé¥±å’Œ**: ä»Agentè§’åº¦çœ‹çš„è®¨è®ºé¥±å’Œç¨‹åº¦
- **Agentç–²åŠ³**: Agentçš„ç–²åŠ³æŒ‡æ ‡
- **å…¨å±€çŠ¶æ€**: æ•´ä½“è®¨è®ºçš„åœæ­¢ä¿¡å·
- **æ—¶é—´å› å­**: åŸºäºè®¨è®ºæŒç»­æ—¶é—´çš„å› å­

### Value Score (ä»·å€¼åˆ†æ•°)
- **è½®æ¬¡è´¨é‡**: æœ€è¿‘å‘è¨€çš„è´¨é‡è¯„ä¼°
- **å†å²è¡¨ç°**: Agentçš„å†å²è´¡çŒ®ä»·å€¼
- **äº’åŠ¨æ½œåŠ›**: äº§ç”Ÿæœ‰æ„ä¹‰äº’åŠ¨çš„æ½œåŠ›
- **ä¸“ä¸šç›¸å…³æ€§**: ä¸è®¨è®ºä¸»é¢˜çš„ç›¸å…³ç¨‹åº¦

### Repeat Risk (é‡å¤é£é™©)
- **è‡ªæˆ‘ç›¸ä¼¼æ€§**: ä¸è‡ªå·±ä¹‹å‰å‘è¨€çš„ç›¸ä¼¼åº¦
- **æ¨¡å¼é‡å¤**: äº¤æµæ¨¡å¼çš„é‡å¤ç¨‹åº¦
- **è®ºç‚¹å›æ”¶**: é‡å¤ä½¿ç”¨ç›¸åŒè®ºç‚¹çš„é£é™©
- **é¢‘ç‡é£é™©**: åŸºäºå‘è¨€é¢‘ç‡çš„é‡å¤é£é™©

## é…ç½®é€‰é¡¹

```python
controller = ContinuousDiscussionController(
    max_turns=50,                    # æœ€å¤§è½®æ¬¡æ•°
    max_duration=3600,               # æœ€å¤§æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
    svr_computation_interval=1.0,    # SVRè®¡ç®—é—´éš”
    enable_real_time_updates=True    # å¯ç”¨å®æ—¶æ›´æ–°
)

svr_handler = SVRHandler(
    stop_threshold=0.8,              # åœæ­¢é˜ˆå€¼
    consensus_threshold=0.85,        # å…±è¯†é˜ˆå€¼
    quality_threshold=30.0           # è´¨é‡é˜ˆå€¼
)
```

## æ€§èƒ½ç›‘æ§

æ¡†æ¶æä¾›è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡ï¼š

- **è®¡ç®—æ•ˆç‡**: å¹¶è¡ŒSVRè®¡ç®—çš„æ•ˆç‡ç»Ÿè®¡
- **å†³ç­–å‡†ç¡®æ€§**: å†³ç­–åˆ¶å®šçš„å‡†ç¡®æ€§è·Ÿè¸ª
- **å‚ä¸åº¦å¹³è¡¡**: å„Agentå‚ä¸åº¦çš„å¹³è¡¡æ€§
- **è®¨è®ºè´¨é‡è¶‹åŠ¿**: è®¨è®ºè´¨é‡çš„å˜åŒ–è¶‹åŠ¿

## æµ‹è¯•

è¿è¡Œæµ‹è¯•å¥—ä»¶ï¼š

```bash
cd Server/discussion_framework
python test_framework.py
```

æµ‹è¯•åŒ…æ‹¬ï¼š
- åŸºæœ¬æ¡†æ¶åŠŸèƒ½æµ‹è¯•
- æ¡†æ¶ç®¡ç†å™¨æµ‹è¯•
- SVRè®¡ç®—æµ‹è¯•
- é›†æˆæµ‹è¯•

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è®¨è®ºæ— æ³•å¯åŠ¨**
   - æ£€æŸ¥Agenté…ç½®æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æˆ¿é—´å­˜åœ¨ä¸”æœ‰å¯ç”¨Agent
   - æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

2. **SVRè®¡ç®—è¶…æ—¶**
   - æ£€æŸ¥Agent.think()æ–¹æ³•çš„å“åº”æ—¶é—´
   - è°ƒæ•´SVRè®¡ç®—è¶…æ—¶è®¾ç½®
   - ç¡®è®¤ç½‘ç»œè¿æ¥ç¨³å®š

3. **WebSocketè¿æ¥å¤±è´¥**
   - ç¡®è®¤è®¨è®ºä¼šè¯å·²å¯åŠ¨
   - æ£€æŸ¥WebSocketç«¯ç‚¹è·¯å¾„
   - éªŒè¯æˆ¿é—´IDæ­£ç¡®æ€§

### æ—¥å¿—çº§åˆ«

```python
import logging
logging.getLogger('Server.discussion_framework').setLevel(logging.DEBUG)
```

## æ‰©å±•å¼€å‘

æ¡†æ¶è®¾è®¡ä¸ºå¯æ‰©å±•çš„ï¼Œæ”¯æŒï¼š

- è‡ªå®šä¹‰SVRç®—æ³•å®ç°
- æ–°çš„å†³ç­–ç­–ç•¥
- é¢å¤–çš„äº‹ä»¶ç±»å‹
- è‡ªå®šä¹‰å‰ç«¯æ¥å£

è¯¦ç»†çš„æ‰©å±•æŒ‡å—è¯·å‚è€ƒå¼€å‘æ–‡æ¡£ã€‚
