<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocioPulse AI</title>
    <style>
        :root {
            /* ÁôΩÂ§©Ê®°Âºè */
            --primary-color: #2196F3;
            --secondary-color: #FFF;
            --text-color: #333;
            --bg-color: #F5F5F5;
            --chat-bg: #FFF;
            --user-bubble: #2196F3;
            --agent-bubble: #E0E0E0;
            --border-color: #DDD;
            --shadow: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            /* ÈªëÂ§úÊ®°Âºè */
            --primary-color: #FF9800;
            --secondary-color: #2A2A2A;
            --text-color: #E0E0E0;
            --bg-color: #1A1A1A;
            --chat-bg: #2A2A2A;
            --user-bubble: #FF9800;
            --agent-bubble: #3A3A3A;
            --border-color: #444;
            --shadow: rgba(255,255,255,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* È°∂ÈÉ®Ê†è */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .top-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        /* ËÅäÂ§©ÂàóË°® */
        .chat-list {
            width: 300px;
            background-color: var(--secondary-color);
            border-right: 1px solid var(--border-color);
            margin-top: 60px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .chat-list-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--primary-color);
        }

        .add-chat-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-chat-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .chat-items {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .chat-item:hover {
            background-color: var(--bg-color);
        }

        .chat-item.active {
            background-color: var(--bg-color);
            border-left: 3px solid var(--primary-color);
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .chat-info {
            flex: 1;
            overflow: hidden;
        }

        .chat-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .chat-preview {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 10px;
            height: 10px;
            background-color: #F44336;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ËÅäÂ§©Âå∫Âüü */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-top: 60px;
            background-color: var(--chat-bg);
            position: relative;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .icon-btn:hover {
            background-color: var(--bg-color);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background-color: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.agent .message-bubble {
            background-color: var(--agent-bubble);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* ËæìÂÖ•Ê°Ü */
        .input-container {
            padding: 20px;
            background-color: var(--secondary-color);
            border-top: 1px solid var(--border-color);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .input-container.hidden {
            transform: translateY(100%);
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            background-color: var(--bg-color);
            border-radius: 25px;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            transition: border-color 0.3s ease;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary-color);
        }

        .message-input {
            flex: 1;
            border: none;
            background: none;
            color: var(--text-color);
            outline: none;
            resize: none;
            max-height: 120px;
            line-height: 1.5;
            font-family: inherit;
        }

        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        /* Â∑•‰ΩúÂå∫ */
        .workspace {
            display: none;
            flex: 1;
            margin-top: 60px;
            background-color: var(--chat-bg);
            padding: 20px;
        }

        .workspace.active {
            display: block;
        }

        .workspace-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .workspace-content {
            background-color: var(--secondary-color);
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        /* Á©∫Áä∂ÊÄÅ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            text-align: center;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .chat-list {
                position: fixed;
                left: 0;
                top: 60px;
                bottom: 0;
                z-index: 999;
                transform: translateX(-100%);
            }

            .chat-list.show {
                transform: translateX(0);
            }

            .chat-area {
                margin-left: 0;
            }
        }

        /* Âä†ËΩΩÂä®Áîª */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-color);
            border-radius: 50%;
            opacity: 0.4;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* AgentÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .agent-config-modal {
            background-color: var(--secondary-color);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px var(--shadow);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-color);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .close-btn:hover {
            background-color: var(--bg-color);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .chat-type-selector {
            margin-bottom: 20px;
        }

        .chat-type-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .chat-type-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
        }

        .room-name-input {
            margin-bottom: 20px;
        }

        .room-name-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .room-name-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
        }

        .agents-config {
            margin-bottom: 20px;
        }

        .agent-config-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--bg-color);
        }

        .agent-header {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .agent-name {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            font-size: 14px;
        }

        .agent-role {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            font-size: 14px;
        }

        .remove-agent-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
        }

        .remove-agent-btn:hover {
            background-color: #d32f2f;
        }

        .agent-prompt {
            margin-bottom: 15px;
        }

        .agent-prompt label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 14px;
        }

        .agent-prompt textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }

        .agent-model {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .agent-model label {
            font-weight: 600;
            color: var(--text-color);
            font-size: 14px;
            white-space: nowrap;
        }

        .model-selector {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            font-size: 14px;
        }

        .add-agent-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-agent-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .cancel-btn, .create-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .cancel-btn {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .cancel-btn:hover {
            background-color: var(--border-color);
        }

        .create-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .create-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .create-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .settings-modal {
            background-color: var(--secondary-color);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 10px 30px var(--shadow);
            animation: modalSlideIn 0.3s ease;
        }

        .settings-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-color);
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            background-color: var(--secondary-color);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background-color: var(--secondary-color);
        }

        .tab-content {
            display: none;
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .setting-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .setting-section h4 {
            margin-bottom: 15px;
            color: var(--text-color);
            font-size: 16px;
        }

        .platform-config {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
        }

        .platform-config h4 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 16px;
        }

        .config-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .config-row:last-child {
            margin-bottom: 0;
        }

        .config-row label {
            min-width: 120px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 14px;
        }

        .config-row input[type="text"],
        .config-row input[type="password"],
        .config-row input[type="number"],
        .config-row select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            font-size: 14px;
        }

        .config-row input[type="range"] {
            flex: 1;
            margin: 0 10px;
            max-width: 300px;
        }

        .test-btn {
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .test-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .test-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .model-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .model-checkboxes label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            min-width: auto;
            cursor: pointer;
        }

        .model-checkboxes input[type="checkbox"] {
            margin: 0;
        }

        /* ÂºÄÂÖ≥Ê†∑Âºè */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .action-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .action-btn.danger {
            background-color: #f44336;
        }

        .action-btn.danger:hover {
            background-color: #d32f2f;
        }

        .storage-info {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .storage-info p {
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-color);
        }

        .storage-info p:last-child {
            margin-bottom: 0;
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- È°∂ÈÉ®Ê†è -->
        <div class="top-bar">
            <div class="logo">SocioPulse AI</div>
            <div class="top-controls">
                <button class="icon-btn" id="settingsBtn" title="ËÆæÁΩÆ">‚öôÔ∏è</button>
                <button class="theme-toggle" title="ÂàáÊç¢‰∏ªÈ¢ò">üåô</button>
            </div>
        </div>

        <!-- ËÅäÂ§©ÂàóË°® -->
        <div class="chat-list" id="chatList">
            <div class="chat-list-header">
                <input type="text" class="search-input" placeholder="ÊêúÁ¥¢ËÅäÂ§©...">
                <button class="add-chat-btn" title="Êñ∞Âª∫ËÅäÂ§©">+</button>
            </div>
            <div class="chat-items" id="chatItems">
                <!-- ËÅäÂ§©È°πÁõÆÂ∞ÜÂä®ÊÄÅÊ∑ªÂä† -->
            </div>
        </div>

        <!-- ËÅäÂ§©Âå∫Âüü -->
        <div class="chat-area" id="chatArea">
            <div class="empty-state">
                <div class="empty-state-icon">üí¨</div>
                <h3>Ê¨¢Ëøé‰ΩøÁî® SocioPulse AI</h3>
                <p>ÈÄâÊã©ÊàñÂàõÂª∫‰∏Ä‰∏™ËÅäÂ§©ÂºÄÂßãÂØπËØù</p>
            </div>
        </div>

        <!-- Â∑•‰ΩúÂå∫ -->
        <div class="workspace" id="workspace">
            <div class="workspace-header">
                <h2>Â∑•‰ΩúÂå∫</h2>
                <button class="icon-btn" id="backToChat">ËøîÂõûËÅäÂ§©</button>
            </div>
            <div class="workspace-content" id="workspaceContent">
                <!-- Â∑•‰ΩúÂå∫ÂÜÖÂÆπ -->
            </div>
        </div>

        <!-- ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
        <div class="modal-overlay" id="settingsModal">
            <div class="settings-modal">
                <div class="modal-header">
                    <h3>Á≥ªÁªüËÆæÁΩÆ</h3>
                    <button class="close-btn" id="closeSettingsModal">√ó</button>
                </div>
                
                <div class="modal-body">
                    <div class="settings-tabs">
                        <button class="tab-btn active" data-tab="models">Ê®°ÂûãÈÖçÁΩÆ</button>
                        <button class="tab-btn" data-tab="features">ÂäüËÉΩËÆæÁΩÆ</button>
                        <button class="tab-btn" data-tab="data">Êï∞ÊçÆÁÆ°ÁêÜ</button>
                    </div>
                    
                    <!-- Ê®°ÂûãÈÖçÁΩÆÊ†áÁ≠æÈ°µ -->
                    <div class="tab-content active" id="modelsTab">
                        <div class="setting-section">
                            <h4>ÈªòËÆ§Âπ≥Âè∞</h4>
                            <select id="defaultPlatformSelect">
                                <option value="aihubmix">AiHubMix</option>
                                <option value="openai">OpenAI</option>
                                <option value="zhipu">Êô∫Ë∞±AI</option>
                            </select>
                        </div>
                        
                        <div class="platform-configs">
                            <!-- OpenAIÈÖçÁΩÆ -->
                            <div class="platform-config" data-platform="openai">
                                <h4>OpenAI ÈÖçÁΩÆ</h4>
                                <div class="config-row">
                                    <label>API Key:</label>
                                    <input type="password" id="openaiApiKey" placeholder="sk-...">
                                    <button class="test-btn" data-platform="openai">ÊµãËØï</button>
                                </div>
                                <div class="config-row">
                                    <label>API Base:</label>
                                    <input type="text" id="openaiApiBase" value="https://api.openai.com/v1">
                                </div>
                                <div class="config-row">
                                    <label>ÂèØÁî®Ê®°Âûã:</label>
                                    <div class="model-checkboxes" id="openaiModels">
                                        <label><input type="checkbox" value="gpt-4" checked> GPT-4</label>
                                        <label><input type="checkbox" value="gpt-4-turbo"> GPT-4 Turbo</label>
                                        <label><input type="checkbox" value="gpt-3.5-turbo"> GPT-3.5 Turbo</label>
                                    </div>
                                </div>
                                <div class="config-row">
                                    <label>ÈªòËÆ§Ê®°Âûã:</label>
                                    <select id="openaiDefaultModel">
                                        <option value="gpt-4">GPT-4</option>
                                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- AiHubMixÈÖçÁΩÆ -->
                            <div class="platform-config" data-platform="aihubmix">
                                <h4>AiHubMix ÈÖçÁΩÆ</h4>
                                <div class="config-row">
                                    <label>API Key:</label>
                                    <input type="password" id="aihubmixApiKey" placeholder="ËæìÂÖ•API Key">
                                    <button class="test-btn" data-platform="aihubmix">ÊµãËØï</button>
                                </div>
                                <div class="config-row">
                                    <label>API Base:</label>
                                    <input type="text" id="aihubmixApiBase" value="https://aihubmix.com/v1">
                                </div>
                                <div class="config-row">
                                    <label>ÂèØÁî®Ê®°Âûã:</label>
                                    <div class="model-checkboxes" id="aihubmixModels">
                                        <label><input type="checkbox" value="gpt-4o-mini" checked> GPT-4o Mini</label>
                                        <label><input type="checkbox" value="gpt-4o-search-preview"> GPT-4o Search Preview</label>
                                        <label><input type="checkbox" value="gpt-4o-mini-search-preview"> GPT-4o Mini Search Preview</label>
                                    </div>
                                </div>
                                <div class="config-row">
                                    <label>ÈªòËÆ§Ê®°Âûã:</label>
                                    <select id="aihubmixDefaultModel">
                                        <option value="gpt-4o-mini">GPT-4o Mini</option>
                                        <option value="gpt-4o-search-preview">GPT-4o Search Preview</option>
                                        <option value="gpt-4o-mini-search-preview">GPT-4o Mini Search Preview</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Êô∫Ë∞±AIÈÖçÁΩÆ -->
                            <div class="platform-config" data-platform="zhipu">
                                <h4>Êô∫Ë∞±AI ÈÖçÁΩÆ</h4>
                                <div class="config-row">
                                    <label>API Key:</label>
                                    <input type="password" id="zhipuApiKey" placeholder="ËæìÂÖ•API Key">
                                    <button class="test-btn" data-platform="zhipu">ÊµãËØï</button>
                                </div>
                                <div class="config-row">
                                    <label>API Base:</label>
                                    <input type="text" id="zhipuApiBase" value="https://open.bigmodel.cn/api/paas/v4">
                                </div>
                                <div class="config-row">
                                    <label>ÂèØÁî®Ê®°Âûã:</label>
                                    <div class="model-checkboxes" id="zhipuModels">
                                        <label><input type="checkbox" value="glm-4" checked> GLM-4</label>
                                        <label><input type="checkbox" value="glm-4-plus"> GLM-4 Plus</label>
                                        <label><input type="checkbox" value="glm-3-turbo"> GLM-3 Turbo</label>
                                    </div>
                                </div>
                                <div class="config-row">
                                    <label>ÈªòËÆ§Ê®°Âûã:</label>
                                    <select id="zhipuDefaultModel">
                                        <option value="glm-4">GLM-4</option>
                                        <option value="glm-4-plus">GLM-4 Plus</option>
                                        <option value="glm-3-turbo">GLM-3 Turbo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÂäüËÉΩËÆæÁΩÆÊ†áÁ≠æÈ°µ -->
                    <div class="tab-content" id="featuresTab">
                        <div class="setting-section">
                            <h4>Agent‰∏ªÂä®ËÅäÂ§©</h4>
                            <div class="config-row">
                                <label>ÂêØÁî®‰∏ªÂä®ËÅäÂ§©:</label>
                                <label class="switch">
                                    <input type="checkbox" id="proactiveChatEnabled">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="config-row">
                                <label>ÁõëÂê¨Èó¥Èöî (Áßí):</label>
                                <input type="range" id="monitoringInterval" min="1" max="60" value="5">
                                <span id="intervalValue">5</span>
                            </div>
                            <div class="config-row">
                                <label>ÁΩÆ‰ø°Â∫¶ÈòàÂÄº:</label>
                                <input type="range" id="confidenceThreshold" min="0.1" max="1.0" step="0.1" value="0.8">
                                <span id="confidenceValue">0.8</span>
                            </div>
                            <div class="config-row">
                                <label>ÊØèÂ∞èÊó∂ÊúÄÂ§ßÂª∫ËÆÆ:</label>
                                <input type="number" id="maxSuggestionsPerHour" min="1" max="20" value="3">
                            </div>
                        </div>
                        
                        <div class="setting-section">
                            <h4>ÁïåÈù¢ËÆæÁΩÆ</h4>
                            <div class="config-row">
                                <label>ÈªòËÆ§‰∏ªÈ¢ò:</label>
                                <select id="defaultTheme">
                                    <option value="light">ÊµÖËâ≤‰∏ªÈ¢ò</option>
                                    <option value="dark">Ê∑±Ëâ≤‰∏ªÈ¢ò</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Êï∞ÊçÆÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
                    <div class="tab-content" id="dataTab">
                        <div class="setting-section">
                            <h4>ÈÖçÁΩÆÁÆ°ÁêÜ</h4>
                            <div class="config-row">
                                <button class="action-btn" id="exportConfigBtn">ÂØºÂá∫ÈÖçÁΩÆ</button>
                                <button class="action-btn" id="importConfigBtn">ÂØºÂÖ•ÈÖçÁΩÆ</button>
                                <input type="file" id="importConfigFile" accept=".json" style="display: none;">
                            </div>
                            <div class="config-row">
                                <button class="action-btn danger" id="resetSettingsBtn">ÈáçÁΩÆÊâÄÊúâËÆæÁΩÆ</button>
                            </div>
                        </div>
                        
                        <div class="setting-section">
                            <h4>Â≠òÂÇ®‰ø°ÊÅØ</h4>
                            <div class="storage-info">
                                <p>ÈÖçÁΩÆÂ≠òÂÇ®: <span id="storageSize">ËÆ°ÁÆó‰∏≠...</span></p>
                                <p>ÊúÄÂêéÊõ¥Êñ∞: <span id="lastUpdate">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="cancel-btn" id="cancelSettingsBtn">ÂèñÊ∂à</button>
                    <button class="create-btn" id="saveSettingsBtn">‰øùÂ≠òËÆæÁΩÆ</button>
                </div>
            </div>
        </div>

        <!-- AgentÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü -->
        <div class="modal-overlay" id="agentConfigModal">
            <div class="agent-config-modal">
                <div class="modal-header">
                    <h3>ÂàõÂª∫Êñ∞ËÅäÂ§©</h3>
                    <button class="close-btn" id="closeModal">√ó</button>
                </div>
                
                <div class="modal-body">
                    <div class="room-name-input">
                        <label>ËÅäÂ§©ÂÆ§ÂêçÁß∞Ôºö</label>
                        <input type="text" id="roomNameInput" placeholder="ËæìÂÖ•ËÅäÂ§©ÂÆ§ÂêçÁß∞...">
                    </div>
                    
                    <div class="chat-type-selector">
                        <label>ËÅäÂ§©Á±ªÂûãÔºö</label>
                        <select id="chatTypeSelect">
                            <option value="single">Âçï‰∏™AgentÂØπËØù</option>
                            <option value="group">Â§öAgentÁæ§ËÅä</option>
                        </select>
                    </div>
                    
                    <div class="agents-config" id="agentsConfig">
                        <!-- AgentÈÖçÁΩÆÈ°πÂ∞ÜÂä®ÊÄÅÊ∑ªÂä† -->
                    </div>
                    
                    <button class="add-agent-btn" id="addAgentBtn">+ Ê∑ªÂä†Agent</button>
                </div>
                
                <div class="modal-footer">
                    <button class="cancel-btn" id="cancelBtn">ÂèñÊ∂à</button>
                    <button class="create-btn" id="createRoomBtn">ÂàõÂª∫ËÅäÂ§©</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let ws = null;
        let currentRoomId = null;
        let currentTheme = 'light';
        let rooms = {};
        let messages = {};
        
        // Ê∂àÊÅØÂéªÈáçÁ≥ªÁªü
        let displayedMessages = new Set(); // Â∑≤ÊòæÁ§∫ÁöÑÊ∂àÊÅØIDÈõÜÂêà
        let lastSentMessage = null; // ÊúÄÂêéÂèëÈÄÅÁöÑÊ∂àÊÅØ‰ø°ÊÅØ
        let recentUserMessages = []; // ÊúÄËøëÂèëÈÄÅÁöÑÁî®Êà∑Ê∂àÊÅØÁºìÂ≠ò
        
        // ÁîüÊàêÊ∂àÊÅØIDÔºàÂü∫‰∫éÂÜÖÂÆπÁöÑÁÆÄÂåñÁâàÔºâ
        function generateMessageId(message) {
            return `${message.sender}_${message.content}_${message.timestamp}`;
        }
        
        // ÁîüÊàêÂü∫‰∫éÂÜÖÂÆπÁöÑÂéªÈáçIDÔºàÂøΩÁï•Êó∂Èó¥Êà≥Â∑ÆÂºÇÔºâ
        function generateContentBasedId(message) {
            return `${message.sender}_${message.content}`;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶ÊòØÈáçÂ§çÁöÑÁî®Êà∑Ê∂àÊÅØ
        function isDuplicateUserMessage(message) {
            if (message.sender !== 'user') {
                return false;
            }
            
            const contentId = generateContentBasedId(message);
            const messageTime = new Date(message.timestamp).getTime();
            
            // Ê£ÄÊü•ÊúÄËøë5ÂàÜÈíüÂÜÖÊòØÂê¶ÊúâÁõ∏ÂêåÂÜÖÂÆπÁöÑÊ∂àÊÅØ
            const fiveMinutesAgo = messageTime - 5 * 60 * 1000;
            
            for (const recentMsg of recentUserMessages) {
                const recentTime = new Date(recentMsg.timestamp).getTime();
                const recentContentId = generateContentBasedId(recentMsg);
                
                // Â¶ÇÊûúÂÜÖÂÆπÁõ∏Âêå‰∏îÊó∂Èó¥Â∑ÆÂú®5ÂàÜÈíüÂÜÖÔºåËÆ§‰∏∫ÊòØÈáçÂ§çÊ∂àÊÅØ
                if (recentContentId === contentId && recentTime >= fiveMinutesAgo) {
                    const timeDiff = Math.abs(messageTime - recentTime);
                    console.log(`üîç Found potential duplicate: time diff = ${timeDiff}ms`);
                    
                    // Â¶ÇÊûúÊó∂Èó¥Â∑ÆÂú®30ÁßíÂÜÖÔºåÂæàÂèØËÉΩÊòØÈáçÂ§çÊ∂àÊÅØ
                    if (timeDiff <= 30000) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        // ËÆ∞ÂΩïÁî®Êà∑Ê∂àÊÅØ
        function recordUserMessage(message) {
            if (message.sender === 'user') {
                recentUserMessages.push({
                    content: message.content,
                    timestamp: message.timestamp,
                    sender: message.sender
                });
                
                // Âè™‰øùÁïôÊúÄËøë50Êù°Ê∂àÊÅØ
                if (recentUserMessages.length > 50) {
                    recentUserMessages = recentUserMessages.slice(-50);
                }
                
                console.log(`üìù Recorded user message, total cached: ${recentUserMessages.length}`);
            }
        }

        // WebSocketËøûÊé•
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                // Ëé∑ÂèñÊàøÈó¥ÂàóË°®
                ws.send(JSON.stringify({ type: 'get_rooms' }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                // Â∞ùËØïÈáçËøû
                setTimeout(connectWebSocket, 3000);
            };
        }

        // Â§ÑÁêÜWebSocketÊ∂àÊÅØ
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'connection':
                    console.log('Connected with ID:', data.connection_id);
                    break;
                case 'rooms_list':
                    updateRoomsList(data.rooms);
                    break;
                case 'room_joined':
                    handleRoomJoined(data);
                    break;
                case 'new_message':
                    handleNewMessage(data);
                    break;
                case 'error':
                    console.error('Server error:', data.message);
                    alert('ÈîôËØØ: ' + data.message);
                    break;
            }
        }

        // Êõ¥Êñ∞ÊàøÈó¥ÂàóË°®
        function updateRoomsList(roomsList) {
            const chatItems = document.getElementById('chatItems');
            chatItems.innerHTML = '';
            
            roomsList.forEach(room => {
                rooms[room.room_id] = room;
                const chatItem = createChatItem(room);
                chatItems.appendChild(chatItem);
            });
        }

        // ÂàõÂª∫ËÅäÂ§©È°πÁõÆ
        function createChatItem(room) {
            const div = document.createElement('div');
            div.className = 'chat-item';
            div.dataset.roomId = room.room_id;
            
            div.innerHTML = `
                <div class="chat-avatar">${room.room_name.charAt(0).toUpperCase()}</div>
                <div class="chat-info">
                    <div class="chat-name">${room.room_name}</div>
                    <div class="chat-preview">${room.agent_count} ‰∏™Agent</div>
                </div>
            `;
            
            div.addEventListener('click', () => selectRoom(room.room_id));
            
            return div;
        }

        // ÈÄâÊã©ÊàøÈó¥
        function selectRoom(roomId) {
            console.log('üè† Selecting room:', roomId);
            
            // Êõ¥Êñ∞UI
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-room-id="${roomId}"]`).classList.add('active');
            
            // ÈáçÁΩÆÊ∂àÊÅØÂéªÈáçÁ≥ªÁªüÔºàÂàáÊç¢ÊàøÈó¥Êó∂Ê∏ÖÁ©∫Ôºâ
            displayedMessages.clear();
            console.log('üßπ Cleared displayed messages for room switch');
            
            currentRoomId = roomId;
            
            // Âä†ÂÖ•ÊàøÈó¥
            ws.send(JSON.stringify({
                type: 'join_room',
                room_id: roomId
            }));
        }

        // Â§ÑÁêÜÂä†ÂÖ•ÊàøÈó¥
        function handleRoomJoined(data) {
            const room = data.room_info;
            showChatArea(room);
        }

        // ÊòæÁ§∫ËÅäÂ§©Âå∫Âüü
        function showChatArea(room) {
            const chatArea = document.getElementById('chatArea');
            
            chatArea.innerHTML = `
                <div class="chat-header">
                    <div class="chat-header-info">
                        <div class="chat-avatar">${room.room_name.charAt(0).toUpperCase()}</div>
                        <div>
                            <div class="chat-name">${room.room_name}</div>
                            <div class="chat-preview">${Object.keys(room.agents).length} ‰∏™AgentÂú®Á∫ø</div>
                        </div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="icon-btn" title="Agent‰ø°ÊÅØ">üë•</button>
                        <button class="icon-btn" title="Êõ¥Â§öÈÄâÈ°π">‚ãÆ</button>
                    </div>
                </div>
                <div class="messages-container" id="messagesContainer">
                    <!-- Ê∂àÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>
                <div class="input-container" id="inputContainer">
                    <div class="input-wrapper">
                        <textarea class="message-input" id="messageInput" 
                                  placeholder="ËæìÂÖ•Ê∂àÊÅØ..." 
                                  rows="1"></textarea>
                        <button class="send-btn" id="sendBtn">‚û§</button>
                    </div>
                </div>
            `;
            
            // ÁªëÂÆö‰∫ã‰ª∂
            setupMessageInput();
            
            // Âä†ËΩΩÂéÜÂè≤Ê∂àÊÅØ
            loadRoomHistory(room.room_id);
        }

        // ËÆæÁΩÆÊ∂àÊÅØËæìÂÖ•
        function setupMessageInput() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            // Ëá™Âä®Ë∞ÉÊï¥È´òÂ∫¶
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
            
            // EnterÂèëÈÄÅÔºåShift+EnterÊç¢Ë°å
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            sendBtn.addEventListener('click', sendMessage);
        }

        // ÂèëÈÄÅÊ∂àÊÅØ
        function sendMessage() {
            console.log('üì§ sendMessage called');
            
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content || !currentRoomId) {
                console.log('‚ùå Message empty or no room selected');
                return;
            }
            
            console.log('üîç WebSocket state:', ws?.readyState);
            console.log('üîç Current room ID:', currentRoomId);
            console.log('üîç Message content:', content);
            
            // Ê£ÄÊü•WebSocketËøûÊé•Áä∂ÊÄÅ
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.error('‚ùå WebSocket not connected');
                alert('ËøûÊé•Â∑≤Êñ≠ÂºÄÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                return;
            }
            
            // ÂèëÈÄÅÂà∞ÊúçÂä°Âô®
            try {
                ws.send(JSON.stringify({
                    type: 'send_message',
                    room_id: currentRoomId,
                    content: content
                }));
                console.log('‚úÖ Message sent to server');
            } catch (error) {
                console.error('‚ùå Failed to send message:', error);
                alert('ÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                return;
            }
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // ÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØ
            console.log('üé® Displaying user message locally');
            displayMessage({
                sender: 'user',
                content: content,
                timestamp: new Date().toISOString(),
                local: true // Ê†áËÆ∞‰∏∫Êú¨Âú∞Ê∂àÊÅØ
            });
        }

        // Â§ÑÁêÜÊñ∞Ê∂àÊÅØ
        function handleNewMessage(data) {
            if (data.room_id === currentRoomId) {
                displayMessage(data.message);
            }
        }

        // ÊòæÁ§∫Ê∂àÊÅØ
        function displayMessage(message) {
            console.log('üé® displayMessage called with:', {
                sender: message.sender,
                content: message.content?.substring(0, 50) + (message.content?.length > 50 ? '...' : ''),
                timestamp: message.timestamp,
                local: message.local || false
            });
            
            const messagesContainer = document.getElementById('messagesContainer');
            if (!messagesContainer) {
                console.error('‚ùå messagesContainer not found');
                return;
            }
            
            // ÁîüÊàêÊ∂àÊÅØÂîØ‰∏ÄIDÔºàÂü∫‰∫éÊó∂Èó¥Êà≥ÁöÑÁ≤æÁ°ÆÂåπÈÖçÔºâ
            const messageId = generateMessageId(message);
            console.log('üîç Generated message ID:', messageId);
            
            // Á¨¨‰∏ÄÂ±ÇÊ£ÄÊü•ÔºöÁ≤æÁ°ÆÂåπÈÖçÔºàÂåÖÂê´Êó∂Èó¥Êà≥Ôºâ
            if (displayedMessages.has(messageId)) {
                console.log('‚ö†Ô∏è Message already displayed (exact match), skipping:', messageId);
                return;
            }
            
            // Á¨¨‰∫åÂ±ÇÊ£ÄÊü•ÔºöÁî®Êà∑Ê∂àÊÅØÁöÑÂÜÖÂÆπÂéªÈáçÔºàÊô∫ËÉΩÂéªÈáçÔºâ
            if (isDuplicateUserMessage(message)) {
                console.log('‚ö†Ô∏è Duplicate user message detected (content-based), skipping');
                return;
            }
            
            // ËÆ∞ÂΩïÁî®Êà∑Ê∂àÊÅØÂà∞ÁºìÂ≠ò
            recordUserMessage(message);
            
            // Ê†áËÆ∞Ê∂àÊÅØ‰∏∫Â∑≤ÊòæÁ§∫
            displayedMessages.add(messageId);
            console.log('‚úÖ Message marked as displayed:', messageId);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.sender === 'user' ? 'user' : 'agent'}`;
            messageDiv.dataset.messageId = messageId; // Ê∑ªÂä†Êï∞ÊçÆÂ±ûÊÄß‰ª•‰æøË∞ÉËØï
            
            const time = new Date(message.timestamp).toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${message.sender === 'user' ? 'U' : 'A'}</div>
                <div class="message-bubble">
                    <div>${message.content}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            console.log('‚úÖ Message displayed, total messages in container:', messagesContainer.children.length);
            console.log('üìä Total displayed message IDs tracked:', displayedMessages.size);
        }

        // Âä†ËΩΩÊàøÈó¥ÂéÜÂè≤
        async function loadRoomHistory(roomId) {
            try {
                const response = await fetch(`/api/rooms/${roomId}/history?limit=50`);
                const data = await response.json();
                
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';
                
                data.history.forEach(msg => {
                    displayMessage({
                        sender: msg.sender_id,
                        content: msg.content,
                        timestamp: msg.timestamp
                    });
                });
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }

        // ‰∏ªÈ¢òÂàáÊç¢
        async function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            
            const themeToggle = document.querySelector('.theme-toggle');
            themeToggle.textContent = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            
            // ‰øùÂ≠ò‰∏ªÈ¢òÂÅèÂ•ΩÂà∞localStorageÔºà‰∏¥Êó∂Â≠òÂÇ®Ôºâ
            localStorage.setItem('theme', currentTheme);
            
            // ÈáçË¶ÅÔºöÂêåÊ≠•Êõ¥Êñ∞Áî®Êà∑ËÆæÁΩÆÔºåÁ°Æ‰øù‰∏ªÈ¢òÂÅèÂ•ΩË¢´ÊåÅ‰πÖÂåñ‰øùÂ≠ò
            try {
                const settings = settingsManager.getSettings();
                settings.features.ui.theme = currentTheme;
                
                // ‰øùÂ≠òÂà∞Êú¨Âú∞ËÆæÁΩÆ
                settingsManager.saveSettings(settings);
                
                // ÂêåÊ≠•Âà∞ÂêéÁ´Ø
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (!result.success) {
                        console.warn('Failed to sync theme to backend:', result.message);
                    }
                } else {
                    console.warn('Failed to sync theme to backend: HTTP', response.status);
                }
                
                // Â¶ÇÊûúËÆæÁΩÆÈù¢ÊùøÊòØÊâìÂºÄÁöÑÔºåÂêåÊ≠•Êõ¥Êñ∞‰∏ªÈ¢òÈÄâÊã©Âô®
                const defaultThemeSelect = document.getElementById('defaultTheme');
                if (defaultThemeSelect && document.getElementById('settingsModal').classList.contains('show')) {
                    defaultThemeSelect.value = currentTheme;
                }
                
            } catch (error) {
                console.error('Error syncing theme setting:', error);
                // Âç≥‰ΩøÂêåÊ≠•Â§±Ë¥•ÔºåÁïåÈù¢‰∏ªÈ¢òÂàáÊç¢‰ªçÁÑ∂ÁîüÊïà
            }
        }

        // AgentÊ®°Êùø
        const agentTemplates = {
            chat: {
                name: "ÈÄöÁî®Âä©Êâã",
                prompt: "‰Ω†ÊòØ‰∏Ä‰∏™ÂèãÂ•Ω„ÄÅÊúâÂ∏ÆÂä©ÁöÑAIÂä©Êâã„ÄÇËØ∑Áî®ÁÆÄÊ¥ÅÊòé‰∫ÜÁöÑÊñπÂºèÂõûÁ≠îÁî®Êà∑ÁöÑÈóÆÈ¢ò„ÄÇ",
                model: "aihubmix"
            },
            mathematician: {
                name: "Êï∞Â≠¶ÂÆ∂",
                prompt: "‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÊï∞Â≠¶ÂÆ∂ÔºåÊìÖÈïøËß£ÂÜ≥ÂêÑÁßçÊï∞Â≠¶ÈóÆÈ¢òÔºåÂåÖÊã¨‰ª£Êï∞„ÄÅÂá†‰Ωï„ÄÅÂæÆÁßØÂàÜÁ≠â„ÄÇËØ∑Áî®Ê∏ÖÊô∞ÁöÑÊ≠•È™§Ëß£ÈáäÊï∞Â≠¶Ê¶ÇÂøµÂíåËß£È¢òËøáÁ®ã„ÄÇ",
                model: "aihubmix"
            },
            programmer: {
                name: "Á®ãÂ∫èÂëò",
                prompt: "‰Ω†ÊòØ‰∏Ä‰ΩçÁªèÈ™å‰∏∞ÂØåÁöÑÁ®ãÂ∫èÂëòÔºåÁ≤æÈÄöÂ§öÁßçÁºñÁ®ãËØ≠Ë®ÄÂíåÂºÄÂèëÊ°ÜÊû∂„ÄÇËØ∑Êèê‰æõÊ∏ÖÊô∞ÁöÑ‰ª£Á†ÅÁ§∫‰æãÂíåÊúÄ‰Ω≥ÂÆûË∑µÂª∫ËÆÆ„ÄÇ",
                model: "aihubmix"
            },
            historian: {
                name: "ÂéÜÂè≤Â≠¶ÂÆ∂",
                prompt: "‰Ω†ÊòØ‰∏Ä‰ΩçÂçöÂ≠¶ÁöÑÂéÜÂè≤Â≠¶ÂÆ∂ÔºåÂØπ‰∏ñÁïåÂéÜÂè≤ÊúâÊ∑±ÂÖ•‰∫ÜËß£„ÄÇËØ∑Êèê‰æõÂáÜÁ°ÆÁöÑÂéÜÂè≤‰ø°ÊÅØÂíåËÉåÊôØÂàÜÊûê„ÄÇ",
                model: "aihubmix"
            },
            custom: {
                name: "Ëá™ÂÆö‰πâAgent",
                prompt: "",
                model: "aihubmix"
            }
        };

        // ÊòæÁ§∫AgentÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü
        function showAgentConfigModal() {
            const modal = document.getElementById('agentConfigModal');
            modal.classList.add('show');
            
            // ÈáçÁΩÆË°®Âçï
            document.getElementById('roomNameInput').value = '';
            document.getElementById('chatTypeSelect').value = 'single';
            
            // Ê∏ÖÁ©∫AgentÈÖçÁΩÆ
            const agentsConfig = document.getElementById('agentsConfig');
            agentsConfig.innerHTML = '';
            
            // Ê∑ªÂä†Á¨¨‰∏Ä‰∏™Agent
            addAgentConfig();
            
            // Êõ¥Êñ∞ËÅäÂ§©Á±ªÂûã
            updateChatType();
        }

        // ÈöêËóèAgentÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü
        function hideAgentConfigModal() {
            const modal = document.getElementById('agentConfigModal');
            modal.classList.remove('show');
        }

        // Ê∑ªÂä†AgentÈÖçÁΩÆÈ°π
        function addAgentConfig() {
            const agentsConfig = document.getElementById('agentsConfig');
            const agentIndex = agentsConfig.children.length;
            
            const agentDiv = document.createElement('div');
            agentDiv.className = 'agent-config-item';
            agentDiv.dataset.agentIndex = agentIndex;
            
            agentDiv.innerHTML = `
                <div class="agent-header">
                    <input type="text" class="agent-name" placeholder="AgentÂêçÁß∞" value="Êô∫ËÉΩÂä©Êâã${agentIndex + 1}">
                    <button type="button" class="remove-agent-btn">Âà†Èô§</button>
                </div>
                
                <div class="agent-prompt">
                    <label>Ëá™ÂÆö‰πâPromptÔºö</label>
                    <textarea placeholder="‰∏∫Ëøô‰∏™AgentÂÆö‰πâËßíËâ≤ÂíåË°å‰∏∫Êåá‰ª§...">${agentTemplates.chat.prompt}</textarea>
                </div>
                
                <div class="agent-model">
                    <label>Ê®°ÂûãÈÄâÊã©Ôºö</label>
                    <select class="model-selector">
                        <!-- Ê®°ÂûãÈÄâÈ°πÂ∞ÜÈÄöËøáupdateAgentModelSelectors()Âä®ÊÄÅÊ∑ªÂä† -->
                    </select>
                </div>
            `;
            
            agentsConfig.appendChild(agentDiv);
            
            // ÁªëÂÆö‰∫ã‰ª∂
            const nameInput = agentDiv.querySelector('.agent-name');
            const promptTextarea = agentDiv.querySelector('.agent-prompt textarea');
            const removeBtn = agentDiv.querySelector('.remove-agent-btn');
            
            // Âà†Èô§Agent
            removeBtn.addEventListener('click', function() {
                if (agentsConfig.children.length > 1) {
                    agentDiv.remove();
                    updateAgentIndices();
                } else {
                    alert('Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏Ä‰∏™Agent');
                }
            });
            
            // Êõ¥Êñ∞Âà†Èô§ÊåâÈíÆÁä∂ÊÄÅ
            updateRemoveButtons();
            
            // Êõ¥Êñ∞Ê®°ÂûãÈÄâÊã©Âô®
            updateAgentModelSelectors();
        }

        // Êõ¥Êñ∞AgentÁ¥¢Âºï
        function updateAgentIndices() {
            const agentsConfig = document.getElementById('agentsConfig');
            Array.from(agentsConfig.children).forEach((item, index) => {
                item.dataset.agentIndex = index;
                const nameInput = item.querySelector('.agent-name');
                if (nameInput.value.match(/^Âä©Êâã\d+$/)) {
                    nameInput.value = `Âä©Êâã${index + 1}`;
                }
            });
            updateRemoveButtons();
        }

        // Êõ¥Êñ∞Âà†Èô§ÊåâÈíÆÁä∂ÊÄÅ
        function updateRemoveButtons() {
            const agentsConfig = document.getElementById('agentsConfig');
            const removeButtons = agentsConfig.querySelectorAll('.remove-agent-btn');
            
            removeButtons.forEach(btn => {
                btn.style.display = agentsConfig.children.length > 1 ? 'block' : 'none';
            });
        }

        // Êõ¥Êñ∞ËÅäÂ§©Á±ªÂûã
        function updateChatType() {
            const chatType = document.getElementById('chatTypeSelect').value;
            const addAgentBtn = document.getElementById('addAgentBtn');
            const agentsConfig = document.getElementById('agentsConfig');
            
            if (chatType === 'single') {
                // ÂçïËÅäÊ®°ÂºèÔºöÂè™ÂÖÅËÆ∏‰∏Ä‰∏™Agent
                addAgentBtn.style.display = 'none';
                while (agentsConfig.children.length > 1) {
                    agentsConfig.removeChild(agentsConfig.lastChild);
                }
            } else {
                // Áæ§ËÅäÊ®°ÂºèÔºöÂÖÅËÆ∏Â§ö‰∏™Agent
                addAgentBtn.style.display = 'block';
            }
            
            updateRemoveButtons();
        }

        // Êî∂ÈõÜAgentÈÖçÁΩÆ
        function collectAgentConfigs() {
            const agentsConfig = document.getElementById('agentsConfig');
            const configs = [];
            
            Array.from(agentsConfig.children).forEach(item => {
                const nameElement = item.querySelector('.agent-name');
                const promptElement = item.querySelector('.agent-prompt textarea');
                const modelElement = item.querySelector('.model-selector');
                
                // Ê∑ªÂä†Á©∫ÂÄºÊ£ÄÊü•ÔºåÈò≤Ê≠¢DOMÂÖÉÁ¥†‰∏çÂ≠òÂú®
                if (!nameElement || !promptElement || !modelElement) {
                    console.warn('AgentÈÖçÁΩÆÈ°πÁº∫Â∞ëÂøÖË¶ÅÁöÑDOMÂÖÉÁ¥†', item);
                    return;
                }
                
                const name = nameElement.value.trim();
                const prompt = promptElement.value.trim();
                const model = modelElement.value;
                
                if (name && model) {
                    configs.push({
                        name: name,
                        prompt: prompt || agentTemplates.chat.prompt,
                        model_type: model
                    });
                }
            });
            
            return configs;
        }

        // ÂàõÂª∫Êñ∞ËÅäÂ§©ÂÆ§
        async function createNewRoomWithConfig() {
            const roomName = document.getElementById('roomNameInput').value.trim();
            const chatType = document.getElementById('chatTypeSelect').value;
            const agentConfigs = collectAgentConfigs();
            
            // È™åËØÅËæìÂÖ•
            if (!roomName) {
                showNotification('ËØ∑ËæìÂÖ•ËÅäÂ§©ÂÆ§ÂêçÁß∞', 'error');
                return;
            }
            
            if (agentConfigs.length === 0) {
                showNotification('ËØ∑Ëá≥Â∞ëÈÖçÁΩÆ‰∏Ä‰∏™Agent', 'error');
                return;
            }
            
            // Á¶ÅÁî®ÂàõÂª∫ÊåâÈíÆÂíåË°®Âçï
            const createBtn = document.getElementById('createRoomBtn');
            const originalText = createBtn.textContent;
            createBtn.disabled = true;
            createBtn.textContent = 'ÂàõÂª∫‰∏≠...';
            
            // Á¶ÅÁî®Ë°®ÂçïËæìÂÖ•
            setFormDisabled(true);
            
            try {
                const response = await fetch('/api/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        room_name: roomName,
                        room_type: chatType,
                        agents: agentConfigs
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('ËÅäÂ§©ÂÆ§ÂàõÂª∫ÊàêÂäüÔºÅ', 'success');
                    
                    // ÈöêËóèÊ®°ÊÄÅÊ°Ü
                    hideAgentConfigModal();
                    
                    // ÈáçÁΩÆË°®Âçï
                    resetRoomCreationForm();
                    
                    // Âà∑Êñ∞ÊàøÈó¥ÂàóË°®
                    ws.send(JSON.stringify({ type: 'get_rooms' }));
                    
                    // ÈÄâÊã©Êñ∞ÂàõÂª∫ÁöÑÊàøÈó¥
                    setTimeout(() => selectRoom(data.room_id), 100);
                } else {
                    // Â§ÑÁêÜ‰∏çÂêåÁ±ªÂûãÁöÑÈîôËØØ
                    handleRoomCreationError(data);
                }
            } catch (error) {
                console.error('Failed to create room:', error);
                showNotification('ÁΩëÁªúÈîôËØØÔºåÂàõÂª∫ËÅäÂ§©ÂÆ§Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï', 'error');
            } finally {
                // ÊÅ¢Â§çÂàõÂª∫ÊåâÈíÆÂíåË°®Âçï
                createBtn.disabled = false;
                createBtn.textContent = originalText;
                setFormDisabled(false);
            }
        }
        
        // Â§ÑÁêÜÊàøÈó¥ÂàõÂª∫ÈîôËØØ
        function handleRoomCreationError(data) {
            const errorType = data.error;
            let message = data.message || 'ÂàõÂª∫Â§±Ë¥•';
            
            switch (errorType) {
                case 'room_name_exists':
                    message = `ÊàøÈó¥ÂêçÁß∞"${data.room_name || ''}"Â∑≤Â≠òÂú®`;
                    if (data.suggested_name) {
                        message += `ÔºåÂª∫ËÆÆ‰ΩøÁî®Ôºö"${data.suggested_name}"`;
                        // Ëá™Âä®Â°´ÂÖ•Âª∫ËÆÆÁöÑÂêçÁß∞
                        document.getElementById('roomNameInput').value = data.suggested_name;
                    }
                    showNotification(message, 'warning');
                    break;
                    
                case 'invalid_model_type':
                    showNotification(`Ê®°ÂûãÈÖçÁΩÆÈîôËØØÔºö${message}`, 'error');
                    break;
                    
                case 'no_agents':
                    showNotification('Ëá≥Â∞ëÈúÄË¶ÅÈÖçÁΩÆ‰∏Ä‰∏™Agent', 'error');
                    break;
                    
                default:
                    if (message.includes('API') || message.includes('Ê®°Âûã')) {
                        showNotification(`Ê®°ÂûãÊúçÂä°ÈîôËØØÔºö${message}`, 'error');
                        // Âª∫ËÆÆÁî®Êà∑Ê£ÄÊü•ËÆæÁΩÆ
                        setTimeout(() => {
                            if (confirm('ÊòØÂê¶ÊâìÂºÄËÆæÁΩÆÈ°µÈù¢Ê£ÄÊü•Ê®°ÂûãÈÖçÁΩÆÔºü')) {
                                showSettingsModal();
                            }
                        }, 2000);
                    } else {
                        showNotification(`ÂàõÂª∫Â§±Ë¥•Ôºö${message}`, 'error');
                    }
            }
        }
        
        // ËÆæÁΩÆË°®ÂçïÁ¶ÅÁî®Áä∂ÊÄÅ
        function setFormDisabled(disabled) {
            const form = document.getElementById('agentConfigModal');
            const inputs = form.querySelectorAll('input, select, textarea, button');
            
            inputs.forEach(input => {
                if (input.id !== 'createRoomBtn') { // ÂàõÂª∫ÊåâÈíÆÂçïÁã¨ÊéßÂà∂
                    input.disabled = disabled;
                }
            });
        }
        
        // ÈáçÁΩÆÊàøÈó¥ÂàõÂª∫Ë°®Âçï
        function resetRoomCreationForm() {
            document.getElementById('roomNameInput').value = '';
            document.getElementById('chatTypeSelect').value = 'single';
            
            // Ê∏ÖÁ©∫AgentÈÖçÁΩÆ
            const agentsConfig = document.getElementById('agentsConfig');
            agentsConfig.innerHTML = '';
            
            // Ê∑ªÂä†‰∏Ä‰∏™ÈªòËÆ§Agent
            addAgentConfig();
            updateChatType();
        }
        
        // ÈÄöÁü•Á≥ªÁªü
        function showNotification(message, type = 'info') {
            // ÂàõÂª∫ÈÄöÁü•ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">${getNotificationIcon(type)}</span>
                    <span class="notification-message">${message}</span>
                    <button class="notification-close">√ó</button>
                </div>
            `;
            
            // Ê∑ªÂä†Ê†∑ÂºèÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÔºâ
            if (!document.querySelector('#notification-styles')) {
                const styles = document.createElement('style');
                styles.id = 'notification-styles';
                styles.textContent = `
                    .notification {
                        position: fixed;
                        top: 80px;
                        right: 20px;
                        z-index: 3000;
                        min-width: 300px;
                        max-width: 500px;
                        background: var(--secondary-color);
                        border-radius: 8px;
                        box-shadow: 0 4px 12px var(--shadow);
                        border-left: 4px solid;
                        animation: slideInRight 0.3s ease;
                    }
                    
                    .notification-success { border-left-color: #4CAF50; }
                    .notification-error { border-left-color: #f44336; }
                    .notification-warning { border-left-color: #ff9800; }
                    .notification-info { border-left-color: var(--primary-color); }
                    
                    .notification-content {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 15px;
                    }
                    
                    .notification-icon {
                        font-size: 20px;
                        flex-shrink: 0;
                    }
                    
                    .notification-message {
                        flex: 1;
                        color: var(--text-color);
                        line-height: 1.4;
                    }
                    
                    .notification-close {
                        background: none;
                        border: none;
                        color: var(--text-color);
                        font-size: 18px;
                        cursor: pointer;
                        padding: 0;
                        width: 24px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        opacity: 0.7;
                        transition: all 0.3s ease;
                    }
                    
                    .notification-close:hover {
                        opacity: 1;
                        background-color: var(--bg-color);
                    }
                    
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(notification);
            
            // ÁªëÂÆöÂÖ≥Èó≠‰∫ã‰ª∂
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.addEventListener('click', () => hideNotification(notification));
            
            // Ëá™Âä®ÈöêËóè
            const duration = type === 'error' ? 8000 : 5000; // ÈîôËØØÊ∂àÊÅØÊòæÁ§∫Êõ¥‰πÖ
            setTimeout(() => hideNotification(notification), duration);
        }
        
        // Ëé∑ÂèñÈÄöÁü•ÂõæÊ†á
        function getNotificationIcon(type) {
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            return icons[type] || icons.info;
        }
        
        // ÈöêËóèÈÄöÁü•
        function hideNotification(notification) {
            if (notification && notification.parentNode) {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }

        // ÊóßÁöÑÂàõÂª∫ÊàøÈó¥ÂáΩÊï∞Ôºà‰øùÊåÅÂÖºÂÆπÊÄßÔºâ
        async function createNewRoom() {
            showAgentConfigModal();
        }

        // ËÆæÁΩÆÁÆ°ÁêÜ
        const settingsManager = {
            // ÈªòËÆ§ËÆæÁΩÆ
            defaultSettings: {
                models: {
                    default_platform: "aihubmix",
                    platforms: {
                        openai: {
                            api_key: "",
                            api_base: "https://api.openai.com/v1",
                            enabled_models: ["gpt-4"],
                            default_model: "gpt-4"
                        },
                        aihubmix: {
                            api_key: "",
                            api_base: "https://aihubmix.com/v1",
                            enabled_models: ["gpt-4o-mini"],
                            default_model: "gpt-4o-mini"
                        },
                        zhipu: {
                            api_key: "",
                            api_base: "https://open.bigmodel.cn/api/paas/v4",
                            enabled_models: ["glm-4"],
                            default_model: "glm-4"
                        }
                    }
                },
                features: {
                    proactive_chat: {
                        enabled: true,
                        monitoring_interval: 5,
                        confidence_threshold: 0.8,
                        max_suggestions_per_hour: 3
                    },
                    ui: {
                        theme: "light"
                    }
                }
            },

            // Ëé∑ÂèñËÆæÁΩÆ
            getSettings() {
                const stored = localStorage.getItem('sociopulse_settings');
                if (stored) {
                    try {
                        return { ...this.defaultSettings, ...JSON.parse(stored) };
                    } catch (e) {
                        console.error('Failed to parse settings:', e);
                    }
                }
                return this.defaultSettings;
            },

            // ‰øùÂ≠òËÆæÁΩÆ
            saveSettings(settings) {
                localStorage.setItem('sociopulse_settings', JSON.stringify(settings));
                this.updateLastModified();
            },

            // Êõ¥Êñ∞ÊúÄÂêé‰øÆÊîπÊó∂Èó¥
            updateLastModified() {
                localStorage.setItem('sociopulse_settings_modified', new Date().toISOString());
            },

            // Ëé∑ÂèñÂ≠òÂÇ®Â§ßÂ∞è
            getStorageSize() {
                const settings = localStorage.getItem('sociopulse_settings') || '';
                const modified = localStorage.getItem('sociopulse_settings_modified') || '';
                return ((settings.length + modified.length) * 2 / 1024).toFixed(2) + ' KB';
            },

            // Ëé∑ÂèñÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
            getLastUpdate() {
                const modified = localStorage.getItem('sociopulse_settings_modified');
                if (modified) {
                    return new Date(modified).toLocaleString('zh-CN');
                }
                return '-';
            },

            // ÈáçÁΩÆËÆæÁΩÆ
            resetSettings() {
                localStorage.removeItem('sociopulse_settings');
                localStorage.removeItem('sociopulse_settings_modified');
            },

            // ÂØºÂá∫ËÆæÁΩÆ
            exportSettings() {
                const settings = this.getSettings();
                const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sociopulse_settings_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            // ÂØºÂÖ•ËÆæÁΩÆ
            importSettings(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const settings = JSON.parse(e.target.result);
                            this.saveSettings(settings);
                            resolve(settings);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            },

            // Ëé∑ÂèñÂèØÁî®Ê®°ÂûãÂàóË°®ÔºàÁî®‰∫éAgentÈÖçÁΩÆÔºâ
            getAvailableModels() {
                const settings = this.getSettings();
                const models = [];
                
                Object.entries(settings.models.platforms).forEach(([platform, config]) => {
                    if (config.enabled_models && config.enabled_models.length > 0) {
                        config.enabled_models.forEach(model => {
                            models.push({
                                value: `${platform}:${model}`,
                                label: `${this.getPlatformDisplayName(platform)} - ${this.getModelDisplayName(model)}`,
                                platform: platform,
                                model: model
                            });
                        });
                    }
                });
                
                return models;
            },

            // Ëé∑ÂèñÂπ≥Âè∞ÊòæÁ§∫ÂêçÁß∞
            getPlatformDisplayName(platform) {
                const names = {
                    openai: 'OpenAI',
                    aihubmix: 'AiHubMix',
                    zhipu: 'Êô∫Ë∞±AI'
                };
                return names[platform] || platform;
            },

            // Ëé∑ÂèñÊ®°ÂûãÊòæÁ§∫ÂêçÁß∞
            getModelDisplayName(model) {
                const names = {
                    'gpt-4': 'GPT-4',
                    'gpt-4-turbo': 'GPT-4 Turbo',
                    'gpt-3.5-turbo': 'GPT-3.5 Turbo',
                    'gpt-4o-mini': 'GPT-4o Mini',
                    'gpt-4o-search-preview': 'GPT-4o Search Preview',
                    'gpt-4o-mini-search-preview': 'GPT-4o Mini Search Preview',
                    'glm-4': 'GLM-4',
                    'glm-4-plus': 'GLM-4 Plus',
                    'glm-3-turbo': 'GLM-3 Turbo'
                };
                return names[model] || model;
            }
        };

        // ÊòæÁ§∫ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        function showSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.classList.add('show');
            loadSettingsToUI();
        }

        // ÈöêËóèËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        function hideSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('show');
        }

        // Âä†ËΩΩËÆæÁΩÆÂà∞UI
        function loadSettingsToUI() {
            const settings = settingsManager.getSettings();
            
            console.log('Loading settings to UI:', settings); // Ë∞ÉËØï‰ø°ÊÅØ
            
            // Ê®°ÂûãÈÖçÁΩÆ
            const defaultPlatformSelect = document.getElementById('defaultPlatformSelect');
            if (defaultPlatformSelect) {
                defaultPlatformSelect.value = settings.models.default_platform;
            }
            
            // ÂêÑÂπ≥Âè∞ÈÖçÁΩÆ
            Object.entries(settings.models.platforms).forEach(([platform, config]) => {
                const apiKeyElement = document.getElementById(`${platform}ApiKey`);
                const apiBaseElement = document.getElementById(`${platform}ApiBase`);
                const defaultModelElement = document.getElementById(`${platform}DefaultModel`);
                
                if (apiKeyElement) apiKeyElement.value = config.api_key || '';
                if (apiBaseElement) apiBaseElement.value = config.api_base || '';
                if (defaultModelElement) defaultModelElement.value = config.default_model || '';
                
                // Êõ¥Êñ∞Ê®°ÂûãÂ§çÈÄâÊ°Ü
                const checkboxes = document.querySelectorAll(`#${platform}Models input[type="checkbox"]`);
                checkboxes.forEach(checkbox => {
                    checkbox.checked = config.enabled_models && config.enabled_models.includes(checkbox.value);
                });
            });
            
            // ÂäüËÉΩËÆæÁΩÆ
            const proactiveChatEnabled = document.getElementById('proactiveChatEnabled');
            const monitoringInterval = document.getElementById('monitoringInterval');
            const intervalValue = document.getElementById('intervalValue');
            const confidenceThreshold = document.getElementById('confidenceThreshold');
            const confidenceValue = document.getElementById('confidenceValue');
            const maxSuggestionsPerHour = document.getElementById('maxSuggestionsPerHour');
            const defaultTheme = document.getElementById('defaultTheme');
            
            if (proactiveChatEnabled) proactiveChatEnabled.checked = settings.features.proactive_chat.enabled;
            if (monitoringInterval) {
                monitoringInterval.value = settings.features.proactive_chat.monitoring_interval;
                if (intervalValue) intervalValue.textContent = settings.features.proactive_chat.monitoring_interval;
            }
            if (confidenceThreshold) {
                confidenceThreshold.value = settings.features.proactive_chat.confidence_threshold;
                if (confidenceValue) confidenceValue.textContent = settings.features.proactive_chat.confidence_threshold;
            }
            if (maxSuggestionsPerHour) maxSuggestionsPerHour.value = settings.features.proactive_chat.max_suggestions_per_hour;
            
            // ÈáçË¶ÅÔºöËÆæÁΩÆ‰∏ªÈ¢òÈÄâÊã©Âô®ÁöÑÂÄºÔºå‰ΩÜ‰∏çË¶ÅÁ´ãÂç≥Â∫îÁî®‰∏ªÈ¢ò
            if (defaultTheme) {
                defaultTheme.value = settings.features.ui.theme;
            }
            
            // Â≠òÂÇ®‰ø°ÊÅØ
            const storageSize = document.getElementById('storageSize');
            const lastUpdate = document.getElementById('lastUpdate');
            if (storageSize) storageSize.textContent = settingsManager.getStorageSize();
            if (lastUpdate) lastUpdate.textContent = settingsManager.getLastUpdate();
        }

        // ‰ªéUIÊî∂ÈõÜËÆæÁΩÆ
        function collectSettingsFromUI() {
            const settings = settingsManager.getSettings();
            
            // Ê®°ÂûãÈÖçÁΩÆ
            settings.models.default_platform = document.getElementById('defaultPlatformSelect').value;
            
            // ÂêÑÂπ≥Âè∞ÈÖçÁΩÆ
            Object.keys(settings.models.platforms).forEach(platform => {
                const config = settings.models.platforms[platform];
                config.api_key = document.getElementById(`${platform}ApiKey`)?.value || "";
                config.api_base = document.getElementById(`${platform}ApiBase`)?.value || "";
                config.default_model = document.getElementById(`${platform}DefaultModel`)?.value || "";
                
                // Êî∂ÈõÜÂêØÁî®ÁöÑÊ®°Âûã
                const checkboxes = document.querySelectorAll(`#${platform}Models input[type="checkbox"]:checked`);
                config.enabled_models = Array.from(checkboxes).map(cb => cb.value);
            });
            
            // ÂäüËÉΩËÆæÁΩÆ
            settings.features.proactive_chat.enabled = document.getElementById('proactiveChatEnabled').checked;
            settings.features.proactive_chat.monitoring_interval = parseInt(document.getElementById('monitoringInterval').value);
            settings.features.proactive_chat.confidence_threshold = parseFloat(document.getElementById('confidenceThreshold').value);
            settings.features.proactive_chat.max_suggestions_per_hour = parseInt(document.getElementById('maxSuggestionsPerHour').value);
            settings.features.ui.theme = document.getElementById('defaultTheme').value;
            
            return settings;
        }

        // ‰øùÂ≠òËÆæÁΩÆ
        async function saveSettings() {
            const saveBtn = document.getElementById('saveSettingsBtn');
            const originalText = saveBtn.textContent;
            
            try {
                // Á¶ÅÁî®‰øùÂ≠òÊåâÈíÆ
                saveBtn.disabled = true;
                saveBtn.textContent = '‰øùÂ≠ò‰∏≠...';
                
                const settings = collectSettingsFromUI();
                
                // ÂèëÈÄÅÂà∞ÂêéÁ´Ø
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                        settingsManager.saveSettings(settings);
                        
                        // Êõ¥Êñ∞AgentÈÖçÁΩÆ‰∏≠ÁöÑÊ®°ÂûãÈÄâÊã©Âô®
                        updateAgentModelSelectors();
                        
                        // ÈáçË¶ÅÔºöÂè™ÊúâÂΩìÁî®Êà∑Âú®ËÆæÁΩÆ‰∏≠ÊòéÁ°ÆÊõ¥Êîπ‰∫Ü‰∏ªÈ¢òÊó∂ÊâçÂàáÊç¢
                        // ‰∏çË¶ÅÂõ†‰∏∫‰øùÂ≠òËÆæÁΩÆËÄåÊÑèÂ§ñÂàáÊç¢‰∏ªÈ¢ò
                        const savedTheme = settings.features.ui.theme;
                        if (savedTheme !== currentTheme) {
                            console.log(`Theme change requested: ${currentTheme} -> ${savedTheme}`);
                            currentTheme = savedTheme === 'light' ? 'dark' : 'light'; // ÂÖàËÆæÁΩÆ‰∏∫Áõ∏ÂèçÂÄº
                            toggleTheme(); // ÁÑ∂ÂêéÂàáÊç¢Âà∞ÁõÆÊ†á‰∏ªÈ¢ò
                        }
                        
                        hideSettingsModal();
                        alert('ËÆæÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ');
                    } else {
                        throw new Error(result.message || '‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•');
                    }
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                alert('‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•: ' + error.message);
            } finally {
                // ÊÅ¢Â§ç‰øùÂ≠òÊåâÈíÆ
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        // ÊµãËØïAPIËøûÊé•
        async function testAPIConnection(platform) {
            const button = document.querySelector(`[data-platform="${platform}"]`);
            const originalText = button.textContent;
            
            button.disabled = true;
            button.textContent = 'ÊµãËØï‰∏≠...';
            
            try {
                const apiKey = document.getElementById(`${platform}ApiKey`).value;
                const apiBase = document.getElementById(`${platform}ApiBase`).value;
                
                if (!apiKey) {
                    throw new Error('ËØ∑ÂÖàËæìÂÖ•API Key');
                }
                
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: platform,
                        api_key: apiKey,
                        api_base: apiBase
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    button.textContent = '‚úì ÊàêÂäü';
                    button.style.backgroundColor = '#4CAF50';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.backgroundColor = '';
                    }, 2000);
                } else {
                    throw new Error(result.error || 'ËøûÊé•Â§±Ë¥•');
                }
            } catch (error) {
                button.textContent = '‚úó Â§±Ë¥•';
                button.style.backgroundColor = '#f44336';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.backgroundColor = '';
                }, 2000);
                alert('ËøûÊé•ÊµãËØïÂ§±Ë¥•: ' + error.message);
            } finally {
                button.disabled = false;
            }
        }

        // Êõ¥Êñ∞AgentÈÖçÁΩÆ‰∏≠ÁöÑÊ®°ÂûãÈÄâÊã©Âô®
        async function updateAgentModelSelectors() {
            try {
                // Ëé∑ÂèñÁî®Êà∑ËÆæÁΩÆ
                const userSettings = settingsManager.getSettings();
                const defaultPlatform = userSettings.models.default_platform;
                
                // ‰ªéÂêéÁ´ØAPIËé∑ÂèñÂèØÁî®Ê®°ÂûãÂàóË°®
                const response = await fetch('/api/available-models');
                const data = await response.json();
                
                if (!data.success) {
                    console.error('Failed to get available models:', data.error);
                    updateAgentModelSelectorsFromSettings();
                    return;
                }
                
                const allModels = data.models;
                const selectors = document.querySelectorAll('.model-selector');
                
                selectors.forEach(selector => {
                    const currentValue = selector.value;
                    selector.innerHTML = '';
                    
                    // Âè™ÊòæÁ§∫ÈªòËÆ§Âπ≥Âè∞ÁöÑÊ®°Âûã
                    const platformModels = allModels.filter(model => {
                        return model.platform === defaultPlatform;
                    });
                    
                    if (platformModels.length === 0) {
                        // Â¶ÇÊûúÈªòËÆ§Âπ≥Âè∞Ê≤°ÊúâÂèØÁî®Ê®°ÂûãÔºåÊòæÁ§∫ÊèêÁ§∫
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = `${settingsManager.getPlatformDisplayName(defaultPlatform)} Âπ≥Âè∞ÊöÇÊó†ÂèØÁî®Ê®°Âûã`;
                        option.disabled = true;
                        selector.appendChild(option);
                        return;
                    }
                    
                    // Áõ¥Êé•Ê∑ªÂä†Ê®°ÂûãÈÄâÈ°πÔºå‰∏çÂàÜÁªÑ
                    platformModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.value; // Ê†ºÂºè: "platform:model"
                        option.textContent = model.label.split(' - ')[1] || model.model; // Âè™ÊòæÁ§∫Ê®°ÂûãÂêçÁß∞
                        if (model.is_default) {
                            option.setAttribute('data-default', 'true');
                        }
                        selector.appendChild(option);
                    });
                    
                    // ÊÅ¢Â§ç‰πãÂâçÁöÑÈÄâÊã©ÔºåÊàñÈÄâÊã©ÈªòËÆ§Ê®°Âûã
                    if (currentValue && selector.querySelector(`option[value="${currentValue}"]`)) {
                        selector.value = currentValue;
                    } else {
                        // ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÈªòËÆ§Ê®°Âûã
                        const defaultOption = selector.querySelector('option[data-default="true"]');
                        if (defaultOption) {
                            selector.value = defaultOption.value;
                        } else if (platformModels.length > 0) {
                            selector.value = platformModels[0].value;
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error updating model selectors:', error);
                // Â¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞ËÆæÁΩÆ‰Ωú‰∏∫ÂêéÂ§á
                updateAgentModelSelectorsFromSettings();
            }
        }

        // ‰ªéÊú¨Âú∞ËÆæÁΩÆÊõ¥Êñ∞Ê®°ÂûãÈÄâÊã©Âô®ÔºàÂêéÂ§áÊñπÊ°àÔºâ
        function updateAgentModelSelectorsFromSettings() {
            const userSettings = settingsManager.getSettings();
            const defaultPlatform = userSettings.models.default_platform;
            const allModels = settingsManager.getAvailableModels();
            const selectors = document.querySelectorAll('.model-selector');
            
            selectors.forEach(selector => {
                const currentValue = selector.value;
                selector.innerHTML = '';
                
                // Âè™ÊòæÁ§∫ÈªòËÆ§Âπ≥Âè∞ÁöÑÊ®°Âûã
                const platformModels = allModels.filter(model => {
                    return model.platform === defaultPlatform;
                });
                
                if (platformModels.length === 0) {
                    // Â¶ÇÊûúÈªòËÆ§Âπ≥Âè∞Ê≤°ÊúâÂèØÁî®Ê®°ÂûãÔºåÊ∑ªÂä†‰∏Ä‰∏™ÈªòËÆ§ÈÄâÈ°π
                    const option = document.createElement('option');
                    option.value = `${defaultPlatform}:default-model`;
                    option.textContent = `${settingsManager.getPlatformDisplayName(defaultPlatform)} ÈªòËÆ§Ê®°Âûã`;
                    selector.appendChild(option);
                    return;
                }
                
                // Áõ¥Êé•Ê∑ªÂä†Ê®°ÂûãÈÄâÈ°πÔºå‰∏çÂàÜÁªÑ
                platformModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = settingsManager.getModelDisplayName(model.model);
                    selector.appendChild(option);
                });
                
                // ÊÅ¢Â§ç‰πãÂâçÁöÑÈÄâÊã©ÔºåÊàñÈÄâÊã©Á¨¨‰∏Ä‰∏™Ê®°Âûã
                if (currentValue && selector.querySelector(`option[value="${currentValue}"]`)) {
                    selector.value = currentValue;
                } else if (platformModels.length > 0) {
                    selector.value = platformModels[0].value;
                } else {
                    // Á°Æ‰øùÊúâ‰∏Ä‰∏™ÈªòËÆ§ÂÄº
                    selector.value = `${defaultPlatform}:default-model`;
                }
            });
        }

        // ËÆæÁΩÆÊ†áÁ≠æÈ°µÂàáÊç¢
        function switchSettingsTab(tabName) {
            // Êõ¥Êñ∞Ê†áÁ≠æÊåâÈíÆ
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Êõ¥Êñ∞ÂÜÖÂÆπÂå∫Âüü
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // ÂàùÂßãÂåñ
        function init() {
            // ÊÅ¢Â§ç‰∏ªÈ¢òËÆæÁΩÆ
            const savedTheme = localStorage.getItem('theme') || 'light';
            currentTheme = savedTheme;
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.querySelector('.theme-toggle').textContent = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            
            // ÁªëÂÆöÂü∫Êú¨‰∫ã‰ª∂
            document.querySelector('.theme-toggle').addEventListener('click', toggleTheme);
            document.querySelector('.add-chat-btn').addEventListener('click', createNewRoom);
            
            // ÁªëÂÆöËÆæÁΩÆÁõ∏ÂÖ≥‰∫ã‰ª∂
            document.getElementById('settingsBtn').addEventListener('click', showSettingsModal);
            document.getElementById('closeSettingsModal').addEventListener('click', hideSettingsModal);
            document.getElementById('cancelSettingsBtn').addEventListener('click', hideSettingsModal);
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            
            // ËÆæÁΩÆÊ†áÁ≠æÈ°µÂàáÊç¢
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchSettingsTab(btn.dataset.tab));
            });
            
            // ÁõëÂê¨ÈªòËÆ§Âπ≥Âè∞ÂèòÊõ¥
            document.getElementById('defaultPlatformSelect').addEventListener('change', function() {
                // ÂΩìÁî®Êà∑Êõ¥ÊîπÈªòËÆ§Âπ≥Âè∞Êó∂ÔºåÁ´ãÂç≥Êõ¥Êñ∞AgentÈÖçÁΩÆ‰∏≠ÁöÑÊ®°ÂûãÈÄâÊã©Âô®
                setTimeout(() => {
                    updateAgentModelSelectors();
                }, 100);
            });
            
            // ÊªëÂùóÂÄºÊõ¥Êñ∞
            document.getElementById('monitoringInterval').addEventListener('input', function() {
                document.getElementById('intervalValue').textContent = this.value;
            });
            document.getElementById('confidenceThreshold').addEventListener('input', function() {
                document.getElementById('confidenceValue').textContent = this.value;
            });
            
            // APIÊµãËØïÊåâÈíÆ
            document.querySelectorAll('.test-btn').forEach(btn => {
                btn.addEventListener('click', () => testAPIConnection(btn.dataset.platform));
            });
            
            // Êï∞ÊçÆÁÆ°ÁêÜÊåâÈíÆ
            document.getElementById('exportConfigBtn').addEventListener('click', () => {
                settingsManager.exportSettings();
            });
            
            document.getElementById('importConfigBtn').addEventListener('click', () => {
                document.getElementById('importConfigFile').click();
            });
            
            document.getElementById('importConfigFile').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        await settingsManager.importSettings(file);
                        loadSettingsToUI();
                        alert('ÈÖçÁΩÆÂØºÂÖ•ÊàêÂäüÔºÅ');
                    } catch (error) {
                        alert('ÈÖçÁΩÆÂØºÂÖ•Â§±Ë¥•: ' + error.message);
                    }
                    this.value = '';
                }
            });
            
            document.getElementById('resetSettingsBtn').addEventListener('click', () => {
                if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâËÆæÁΩÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
                    settingsManager.resetSettings();
                    loadSettingsToUI();
                    alert('ËÆæÁΩÆÂ∑≤ÈáçÁΩÆÔºÅ');
                }
            });
            
            // ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÁÇπÂáªÂÖ≥Èó≠
            document.getElementById('settingsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideSettingsModal();
                }
            });
            
            // ÈòªÊ≠¢ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂÜÖÈÉ®ÁÇπÂáª‰∫ã‰ª∂ÂÜíÊ≥°
            document.querySelector('.settings-modal').addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // ÁªëÂÆöAgentÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü‰∫ã‰ª∂
            document.getElementById('closeModal').addEventListener('click', hideAgentConfigModal);
            document.getElementById('cancelBtn').addEventListener('click', hideAgentConfigModal);
            document.getElementById('createRoomBtn').addEventListener('click', createNewRoomWithConfig);
            document.getElementById('addAgentBtn').addEventListener('click', addAgentConfig);
            document.getElementById('chatTypeSelect').addEventListener('change', updateChatType);
            
            // ÁÇπÂáªAgentÈÖçÁΩÆÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
            document.getElementById('agentConfigModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideAgentConfigModal();
                }
            });
            
            // ÈòªÊ≠¢AgentÈÖçÁΩÆÊ®°ÊÄÅÊ°ÜÂÜÖÈÉ®ÁÇπÂáª‰∫ã‰ª∂ÂÜíÊ≥°
            document.querySelector('.agent-config-modal').addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // ÂàùÂßãÂåñAgentÊ®°ÂûãÈÄâÊã©Âô®
            updateAgentModelSelectors();
            
            // ËøûÊé•WebSocket
            connectWebSocket();
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
